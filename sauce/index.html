<!doctype html>
<html lang="en" data-bs-theme="dark">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=0">
  <title>Online Code Editor</title>
  <link href="/bootstrap.min.css" rel="stylesheet">
  <link href="/styles.css" rel="stylesheet">
  <link rel="stylesheet" href="/module/@xterm/xterm/css/xterm.css" />
  <script src="/module/@xterm/xterm/lib/xterm.js"></script>
  <script src="/module/@xterm/addon-fit/lib/addon-fit.js"></script>
</head>

<body>
  <div class="layout">
    <div class="sidebar">icon goes here</div>
    <div id="editor-wrapper">
      <pre id="editor"></pre>
    </div>
    <div class="overlay-panel">
      <div class="btn-group btn-group-sm float-end" role="group" aria-label="Actions" style="z-index: 1">
        <button type="button" class="btn btn-primary">Run</button>
        <button type="button" class="btn btn-warning" disabled>Stop</button>
        <button type="button" class="btn btn-secondary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown"
          aria-expanded="false">
          <span class="visually-hidden">Toggle Dropdown</span>
        </button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" id="lang-auto">Automatic detect</a></li>
          <li>
            <hr class="dropdown-divider">
          </li>
        </ul>

      </div>
      <div id="terminal"></div>
      <!-- your content here -->
    </div>
  </div>
  <script src="/ace/ace.js"></script>
  <script src="/ace/ext-language_tools.js"></script>
  <script>
    function main() {
      var auto = true;
      var autoLang = '';
      const editor = ace.edit("editor");
      ace.require("ace/ext/language_tools");
      editor.setOptions({
        mode: "ace/mode/javascript",
        theme: "ace/theme/vibrant_ink",
        autoScrollEditorIntoView: true,
        enableBasicAutocompletion: true,
        enableSnippets: true,
        enableLiveAutocompletion: true
      });

      const term = new Terminal({
        convertEol: true
      });
      const fit = new FitAddon.FitAddon();
      term.loadAddon(fit);
      term.open(document.getElementById('terminal'));
      fit.fit();
      term.write('\x1B[1;3;34mOnlineIDE\x1B[0m\n\nUniversal online code editor & compiler\nMade for Canandaigua Academy'
        + '\n\nMore to come:\n- Multi file support\n- Language selection\n- More languages\n\nOnlineIDE@0.0.0-ALPHA\n 2024 @ Dreamnity inc.');
      editor.session.on("change", () => {
        clearTimeout(window?.saveInterval);
        window.saveInterval = setTimeout(detect, auto ? 2000 : 10000);
      });
      function detect() {
        const code = editor.getValue();
        fetch("/api/classify", {
          method: "POST",
          body: code
        }).then(async r => {
          const res = await r.text();
          if (res === 'null' || r.status === 404) return;
          autoLang = res;
          document.getElementById("lang-auto").innerText = "Auto (" + res + ")";
          if (auto) setLang(res);
        })
        localStorage.setItem("code", code);
      }
      function setLang(name) {
        editor.session.setMode("ace/mode/" + name);
      }
      fetch("/api/list").then(r => r.json()).then(l => {
        const dropdown = document.querySelector("ul.dropdown-menu");
        const regex = /[^a-zA-Z0-9\-_]/g
        for (const { language, aliases } of l) {
          const id = regex.test(language) ? aliases.find(e => !regex.test(language)) || language : language
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.className = 'dropdown-item';
          a.id = 'lang-' + id;
          a.innerText = language;
          a.onclick = () => setLang(id);
          li.appendChild(a);
          dropdown.appendChild(li);
        }
      })
      if (localStorage.getItem("code")) editor.setValue(localStorage.getItem("code"));
    }
    main();
  </script>
  <script src="/module/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>